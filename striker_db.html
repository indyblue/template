<!DOCTYPE html>

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
	<title>Attributes example</title>
	<script type="text/javascript" src='striker.js'></script>
	<style>
		template {
			display: none
		}

		h3 {
			margin: 0;
		}

		xth.asc::after { content: "/\\"; float:right;}
		xth.desc::after { content: "\\/";float:right;}
		.table {display:table;}
		xtr,.tr{display:table-row;}
		xth,xtd,.td{display:table-cell;}
		.table, .tr, .td, xtr, xth {
			border:1px solid black;
			border-collapse: collapse;
			padding:.25em;
		}
	</style>
</head>

<body>
	<template id='spreadsheet'>
		<div data-repeat-r-remove=''><div class='tr'>
			<div data-repeat-c-remove="r">
				<div class='td'>{{c}}</div>
			</div>
			<div class='td row-del'>[X]</div>
		</div></div>
	</template>
	<textarea id="tsv-paste"></textarea>
	<button id="tsv-run">TSV Parse</button>
	<div id='tsv-pend' class='table'>
		<xtr>
			<xth>Type</xth>
			<xth>Trans Date</xth>
			<xth>Post Date</xth>
			<xth>Description</xth>
			<xth>Amount</xth>
			<xth>&nbsp;</xth>
		</xtr>
	</div>
	<script>
		'use strict';
		(function () {
			var striker = new Striker();
			var elTa = document.querySelector('#tsv-paste');
			var elBtn = document.querySelector('#tsv-run');
			var elPend = document.querySelector('#tsv-pend');
			elBtn.onclick = function () {
				var txt = elTa.value.trim();
				var data = txt.split(/[\n\r]+/g).map(x => x.split(/\t+/g));
				striker.expend(elPend, '#spreadsheet', data, true);
			};
			elPend.addEventListener('click', function (e) {
				if (!e.target.matches('.tr .row-del')) return;
				var tr = e.target.closest('.tr');
				tr.remove();
			});
			elPend.addEventListener('click', function (e) {
				if (!e.target.matches('xtr xth')) return;
				
				// ***** index stuff *****
				for (var i = 0; !e.target.matches('xth:nth-of-type(' + i + ')') || i > 20; i++);

				var s = 1;
				// ***** class stuff *****
				var remall = function() {
					var ae = e.currentTarget.querySelectorAll('xth');
					for(var i=0;i<ae.length;i++){
						ae[i].classList.remove('asc');
						ae[i].classList.remove('desc');
					}
				};
				if (e.target.classList.contains('asc')) {
					remall();
					e.target.classList.add('desc');
					s = -1;
				} else {
					remall();
					e.target.classList.add('asc');
				}

				// ***** array stuff *****
				var nl = this.querySelectorAll('.tr');
				var l = nl.length, arr = new Array(l);
				while (l--) { arr[l] = nl[l] };

				// ***** sort stuff *****
				var qtd = (x, i) => {
					var v = x.querySelector('.td:nth-of-type(' + i + ')').innerHTML.trim();
					var d = new Date(v);
					if(!isNaN(d.getTime())) return d;
					else if(!isNaN(v)) return parseFloat(v);
					else return v;
				}
				arr.sort((a, b) => (a = qtd(a, i)) === (b = qtd(b, i)) ? 0 : a > b ? s : -s);
				for (var j = 0; j < arr.length; j++) this.append(arr[j]);
			});
		})();
	</script>


</body>

</html>